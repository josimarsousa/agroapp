<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acerto de Contas das colheitas</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/navbar-modern.css">
    <link rel="stylesheet" href="/css/menu-override.css">
    <link rel="stylesheet" href="/css/agroapp-theme.css">
</head>
<body>
<%- include('../partials/header') %>

<div class="container">
    <div class="page-container">
        <div class="page-header">
            <div class="page-header-content">
                <div class="page-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C13.1 2 14 2.9 14 4V6H16C17.1 6 18 6.9 18 8V19C18 20.1 17.1 21 16 21H8C6.9 21 6 20.1 6 19V8C6 6.9 6.9 6 8 6H10V4C10 2.9 10.9 2 12 2ZM12 4V6H12V4ZM8 8V19H16V8H8ZM10 10H14V12H10V10ZM10 14H14V16H10V14Z" fill="currentColor"/>
                    </svg>
                </div>
                <h1>Acerto de contas colheitas</h1>
            </div>
        </div>

        <div class="page-content">
            <% if (messages && messages.error && messages.error.length > 0) { %>
                <div class="alert alert-danger">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                    </svg>
                    <%= messages.error[0] %>
                </div>
            <% } %>
            <% if (messages && messages.success && messages.success.length > 0) { %>
                <div class="alert alert-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
                    </svg>
                    <%= messages.success[0] %>
                </div>
            <% } %>

            <!-- Formulário de Filtro por Data -->
            <div class="card">
                <div class="card-header">
                    <h2>Filtrar por Período</h2>
                    </div>
                    <div class="card-body">
                        <form action="/settlement" method="get">
                            <div class="form-group mb-3">
                                <label for="start_date" class="form-label">Data Inicial:</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="<%= start_date %>">
                            </div>
                            <div class="form-group mb-3">
                                <label for="end_date" class="form-label">Data Final:</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="<%= end_date %>">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="currentColor"/>
                                    </svg>
                                    Filtrar
                                </button>
                                <a href="/settlement" class="btn btn-secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                                    </svg>
                                    Limpar Filtro
                                </a>
                                <% if (start_date && end_date) { %>
                                    <a href="/settlement/export-pdf?start_date=<%= start_date %>&end_date=<%= end_date %>" class="btn btn-success" target="_blank">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" fill="currentColor"/>
                                        </svg>
                                        Exportar PDF
                                    </a>
                                <% } %>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Resumo Geral -->
                <div class="card">
                    <div class="card-header">
                        <h2>Resumo do Período</h2>
                    </div>
                    <div class="card-body">
                        <div class="summary-grid">
                            <div class="summary-item positive">
                                <h3>Total de Vendas</h3>
                                <p class="amount">R$ <%= (summary && summary.totalSalesAmount ? summary.totalSalesAmount.toFixed(2) : '0,00').replace('.', ',') %></p>
                            </div>
                            <div class="summary-item negative">
                                <h3>Total de Perdas (Estimado)</h3>
                                <p class="amount">R$ <%= (summary && summary.totalLossesValue ? summary.totalLossesValue.toFixed(2) : '0,00').replace('.', ',') %></p>
                            </div>
                            <div class="summary-item <%= (summary && summary.netResult >= 0) ? 'positive' : 'negative' %>">
                                <h3>Resultado Líquido</h3>
                                <p class="amount">R$ <%= (summary && summary.netResult ? summary.netResult.toFixed(2) : '0,00').replace('.', ',') %></p>
                            </div>
                            <div class="summary-item">
                                <h3>Margem de Lucro</h3>
                                <p class="percentage"><%= (summary && summary.profitMargin ? summary.profitMargin.toFixed(1) : '0,0') %>%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detalhes das Vendas -->
                <div class="card">
                    <div class="card-header">
                        <h3>Vendas do Período</h3>
                    </div>
                    <div class="card-body">
                        <% if (salesData && salesData.sales.length > 0) { %>
                            <div class="stats-summary">
                                <p><strong>Total de Vendas:</strong> <%= salesData.sales.length %></p>
                                <p><strong>Quantidade Total Vendida:</strong> <%= salesData.totalQuantity %> unidades</p>
                                <p><strong>Valor Total:</strong> R$ <%= salesData.totalAmount.toFixed(2).replace('.', ',') %></p>
                            </div>
                            
                            <h4>Relatório Detalhado de Itens Vendidos</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Cliente</th>
                                            <th>Produto</th>
                                            <th>Quantidade</th>
                                            <th>Preço Unitário</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% salesData.sales.forEach(sale => { %>
                                            <% sale.items.forEach(item => { %>
                                                <tr>
                                                    <td data-label="Data"><%= new Date(sale.sale_date).toLocaleDateString('pt-BR') %></td>
                                                    <td data-label="Cliente"><%= sale.customer ? sale.customer.name : 'Cliente não informado' %></td>
                                                     <td data-label="Produto"><%= item.product ? item.product.name : 'Produto não encontrado' %></td>
                                                    <td data-label="Quantidade"><%= item.quantity %></td>
                                                    <td data-label="Preço Unitário">R$ <%= parseFloat(item.unit_price).toFixed(2).replace('.', ',') %></td>
                                                    <td data-label="Subtotal">R$ <%= parseFloat(item.subtotal).toFixed(2).replace('.', ',') %></td>
                                                </tr>
                                            <% }); %>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            
                            <h4>Resumo por Produto</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Quantidade Vendida</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.keys(salesData.byProduct).forEach(productName => { %>
                                            <tr>
                                                <td data-label="Produto"><%= productName %></td>
                                                <td data-label="Quantidade"><%= salesData.byProduct[productName].quantity %></td>
                                                <td data-label="Valor">R$ <%= salesData.byProduct[productName].amount.toFixed(2).replace('.', ',') %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <p>Nenhuma venda encontrada no período selecionado.</p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Detalhes das Perdas -->
                <div class="card">
                    <div class="card-header">
                        <h3>Perdas do Período</h3>
                    </div>
                    <div class="card-body">
                        <% if (lossesData && lossesData.losses.length > 0) { %>
                            <div class="stats-summary">
                                <p><strong>Total de Perdas:</strong> <%= lossesData.losses.length %></p>
                                <p><strong>Quantidade Total Perdida:</strong> <%= lossesData.totalQuantity %> unidades</p>
                                <p><strong>Valor Estimado das Perdas:</strong> R$ <%= lossesData.totalValue.toFixed(2).replace('.', ',') %></p>
                            </div>
                            
                            <h4>Relatório Detalhado de Itens Perdidos</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Produto</th>
                                            <th>Categoria</th>
                                            <th>Quantidade</th>
                                            <th>Motivo</th>
                                            <th>Preço Estimado</th>
                                            <th>Valor Estimado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% lossesData.losses.forEach(loss => { %>
                                            <tr>
                                                <td data-label="Data"><%= new Date(loss.loss_date).toLocaleDateString('pt-BR') %></td>
                                                <td data-label="Produto"><%= loss.product ? loss.product.name : 'Produto não encontrado' %></td>
                                                <td data-label="Categoria"><%= loss.product && loss.product.category ? loss.product.category.name : 'Categoria não informada' %></td>
                                                <td data-label="Quantidade"><%= loss.quantity %></td>
                                                <td data-label="Motivo"><%= loss.reason || 'Não informado' %></td>
                                                <td data-label="Preço Estimado">R$ <%= loss.product && loss.product.price ? parseFloat(loss.product.price).toFixed(2).replace('.', ',') : '0,00' %></td>
                                                <td data-label="Valor Estimado">R$ <%= (loss.product && loss.product.price ? (loss.quantity * parseFloat(loss.product.price)) : 0).toFixed(2).replace('.', ',') %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            
                            <h4>Resumo por Produto</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Quantidade Perdida</th>
                                            <th>Valor Estimado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.keys(lossesData.byProduct).forEach(productName => { %>
                                            <tr>
                                                <td data-label="Produto"><%= productName %></td>
                                                <td data-label="Quantidade"><%= lossesData.byProduct[productName].quantity %></td>
                                                <td data-label="Valor">R$ <%= lossesData.byProduct[productName].estimatedValue.toFixed(2).replace('.', ',') %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <p>Nenhuma perda encontrada no período selecionado.</p>
                            </div>
                        <% } %>
                    </div>
                </div>

            <div class="card">
                <div class="card-header">
                    <h3>Ações</h3>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center">
                        <a href="/dashboard" class="btn btn-secondary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                            </svg>
                            Voltar ao Dashboard
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="/js/script.js"></script>
</body>
</html>